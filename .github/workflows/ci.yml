name: CI/CD Pipeline - Incident Platform

on:
  push:
    branches: [main, develop]
    paths:
      - 'incident-platform/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
    paths:
      - 'incident-platform/**'
      - '.github/workflows/**'

env:
  POSTGRES_USER: hackathon
  POSTGRES_PASSWORD: hackathon2026
  POSTGRES_DB: incident_platform
  DATABASE_URL: postgresql://hackathon:hackathon2026@localhost:5432/incident_platform
  API_KEYS: hackathon-api-key-2026
  LOGIN_API_KEY: hackathon-api-key-2026
  AUTH_USERS: admin:admin,operator:operator

jobs:
  # =============================================
  # 1. Quality Check - Linting & Formatting
  # =============================================
  quality:
    name: üìè Code Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: incident-platform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install quality tools
        run: pip install flake8 black isort pylint

      - name: Check formatting with Black
        run: |
          black --check --diff services/ || echo "::warning::Black formatting issues found"

      - name: Check imports with isort
        run: |
          isort --check-only --diff services/ || echo "::warning::isort issues found"

      - name: Lint with flake8
        run: |
          flake8 services/ --max-line-length=120 --statistics --count || echo "::warning::Flake8 issues found"

  # =============================================
  # 2. Unit Tests
  # =============================================
  tests:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    needs: quality
    defaults:
      run:
        working-directory: incident-platform

    strategy:
      matrix:
        service:
          - alert-ingestion
          - incident-management
          - oncall-service
          - notification-service
          - api-gateway

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: hackathon
          POSTGRES_PASSWORD: hackathon2026
          POSTGRES_DB: incident_platform
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd services/${{ matrix.service }}
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Run tests
        run: |
          cd services/${{ matrix.service }}
          if [ -d tests ]; then
            pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing
          else
            echo "No tests directory found for ${{ matrix.service }}"
          fi

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.service }}
          path: incident-platform/services/${{ matrix.service }}/coverage.xml
          if-no-files-found: ignore

  # =============================================
  # 3. Security Scan
  # =============================================
  security:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    needs: quality
    defaults:
      run:
        working-directory: incident-platform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: pip install bandit safety

      - name: Run Bandit (SAST)
        run: |
          bandit -r services/ -f json -o bandit-report.json --severity-level medium || true
          bandit -r services/ --severity-level high

      - name: Check dependencies with Safety
        run: |
          for service in services/*/; do
            if [ -f "$service/requirements.txt" ]; then
              echo "üîç Scanning $service..."
              safety check -r "$service/requirements.txt" || echo "::warning::Vulnerabilities found in $service"
            fi
          done

      - name: Check for secrets
        run: |
          echo "üîç Scanning for hardcoded secrets..."
          grep -rn "password\s*=\s*['\"]" services/ --include="*.py" | grep -v "test" | grep -v "__pycache__" || echo "‚úÖ No hardcoded passwords found"
          grep -rn "secret\s*=\s*['\"]" services/ --include="*.py" | grep -v "test" | grep -v "__pycache__" || echo "‚úÖ No hardcoded secrets found"

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: incident-platform/bandit-report.json
          if-no-files-found: ignore

  # =============================================
  # 4. Build Docker Images
  # =============================================
  build:
    name: üèóÔ∏è Build Images
    runs-on: ubuntu-latest
    needs: [tests, security]
    defaults:
      run:
        working-directory: incident-platform

    strategy:
      matrix:
        service:
          - alert-ingestion
          - incident-management
          - oncall-service
          - notification-service
          - api-gateway
          - web-ui

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }}
        run: |
          cd services/${{ matrix.service }}
          docker build -t incident-platform/${{ matrix.service }}:${{ github.sha }} .
          docker build -t incident-platform/${{ matrix.service }}:latest .

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: incident-platform/${{ matrix.service }}:latest
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

  # =============================================
  # 5. Integration Tests
  # =============================================
  integration:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: incident-platform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_USER=hackathon
          POSTGRES_PASSWORD=hackathon2026
          POSTGRES_DB=incident_platform
          DATABASE_URL=postgresql://hackathon:hackathon2026@database:5432/incident_platform
          ALERT_DB_URL=postgresql://hackathon:hackathon2026@database:5432/alert_db
          INCIDENT_DB_URL=postgresql://hackathon:hackathon2026@database:5432/incident_db
          NOTIFICATION_DB_URL=postgresql://hackathon:hackathon2026@database:5432/notification_db
          ALERT_INGESTION_PORT=8001
          INCIDENT_MANAGEMENT_PORT=8002
          ONCALL_SERVICE_PORT=8003
          NOTIFICATION_SERVICE_PORT=8004
          WEB_UI_PORT=8080
          API_KEYS=hackathon-api-key-2026
          LOGIN_API_KEY=hackathon-api-key-2026
          AUTH_USERS=admin:admin,operator:operator
          GRAFANA_ADMIN_USER=admin
          GRAFANA_ADMIN_PASSWORD=admin
          EOF

      - name: Start all services
        run: |
          docker compose up -d --build
          echo "‚è≥ Waiting for services to be healthy..."
          sleep 30

      - name: Wait for healthy services
        run: |
          for i in $(seq 1 30); do
            HEALTHY=$(docker compose ps | grep -c "healthy" || true)
            echo "Attempt $i: $HEALTHY services healthy"
            if [ "$HEALTHY" -ge 6 ]; then
              echo "‚úÖ All services healthy!"
              break
            fi
            sleep 10
          done
          docker compose ps

      - name: Verify database tables are ready
        run: |
          for i in $(seq 1 15); do
            echo "--- Attempt $i ---"
            ALERT_TABLES=$(docker compose exec -T database psql -U hackathon -d alert_db -t -c "SELECT count(*) FROM information_schema.tables WHERE table_schema='public';" 2>/dev/null | tr -d ' ')
            INCIDENT_TABLES=$(docker compose exec -T database psql -U hackathon -d incident_db -t -c "SELECT count(*) FROM information_schema.tables WHERE table_schema='public';" 2>/dev/null | tr -d ' ')
            NOTIF_TABLES=$(docker compose exec -T database psql -U hackathon -d notification_db -t -c "SELECT count(*) FROM information_schema.tables WHERE table_schema='public';" 2>/dev/null | tr -d ' ')
            echo "alert_db: ${ALERT_TABLES:-0} tables, incident_db: ${INCIDENT_TABLES:-0} tables, notification_db: ${NOTIF_TABLES:-0} tables"
            if [ "${ALERT_TABLES:-0}" -ge 1 ] 2>/dev/null && [ "${INCIDENT_TABLES:-0}" -ge 3 ] 2>/dev/null && [ "${NOTIF_TABLES:-0}" -ge 1 ] 2>/dev/null; then
              echo "‚úÖ All per-service databases ready!"
              echo "--- alert_db ---"
              docker compose exec -T database psql -U hackathon -d alert_db -c "\dt"
              echo "--- incident_db ---"
              docker compose exec -T database psql -U hackathon -d incident_db -c "\dt"
              echo "--- notification_db ---"
              docker compose exec -T database psql -U hackathon -d notification_db -c "\dt"
              break
            fi
            sleep 5
          done

      - name: Verify DB connectivity from services
        run: |
          echo "Testing direct DB insert into incident_db..."
          docker compose exec -T database psql -U hackathon -d incident_db -c "
            INSERT INTO incidents (id, title, service, severity, status, assigned_to, alert_count, created_at, updated_at)
            VALUES (gen_random_uuid(), 'DB Test', 'ci-test', 'low', 'open', NULL, 0, NOW(), NOW());
          "
          echo "‚úÖ Direct DB insert works"
          echo "Restarting services to refresh DB connections..."
          docker compose restart alert-ingestion incident-management notification-service
          sleep 15

      - name: Test API Gateway health
        run: |
          curl -sf http://localhost:8080/health || (echo "‚ùå API Gateway not healthy" && exit 1)
          echo "‚úÖ API Gateway healthy"

      - name: Test Login
        run: |
          RESPONSE=$(curl -sf -X POST http://localhost:8080/api/v1/auth/login \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"admin"}')
          echo "Login response: $RESPONSE"
          echo "$RESPONSE" | grep -q "api_key" && echo "‚úÖ Login works" || (echo "‚ùå Login failed" && exit 1)

      - name: Test Incident Creation
        run: |
          for i in $(seq 1 5); do
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:8080/api/v1/incidents \
              -H "Content-Type: application/json" \
              -H "X-API-Key: hackathon-api-key-2026" \
              -d '{
                "title": "CI Test Incident",
                "severity": "low",
                "service": "ci-pipeline"
              }')
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            echo "Attempt $i - HTTP $HTTP_CODE: $BODY"
            if echo "$BODY" | grep -q '"id"'; then
              echo "‚úÖ Incident creation works"
              exit 0
            fi
            echo "Retrying in 10s..."
            docker compose logs --tail=5 incident-management
            sleep 10
          done
          echo "‚ùå Incident creation failed after 5 attempts"
          docker compose logs incident-management
          exit 1

      - name: Test Get Incidents
        run: |
          RESPONSE=$(curl -s http://localhost:8080/api/v1/incidents \
            -H "X-API-Key: hackathon-api-key-2026")
          echo "Get incidents: $RESPONSE"
          echo "‚úÖ Get incidents works"

      - name: Test Alert Ingestion
        run: |
          RESPONSE=$(curl -s -X POST http://localhost:8080/api/v1/alerts \
            -H "Content-Type: application/json" \
            -H "X-API-Key: hackathon-api-key-2026" \
            -d '{
              "source": "github-actions",
              "severity": "low",
              "message": "CI test alert",
              "service": "ci-pipeline"
            }')
          echo "Create alert: $RESPONSE"
          echo "‚úÖ Alert ingestion works"

      - name: Test On-Call Schedules
        run: |
          RESPONSE=$(curl -s http://localhost:8080/api/v1/schedules \
            -H "X-API-Key: hackathon-api-key-2026")
          echo "Schedules: $RESPONSE"
          echo "‚úÖ On-Call service works"

      - name: Test Notifications
        run: |
          RESPONSE=$(curl -s -X POST http://localhost:8080/api/v1/notify \
            -H "Content-Type: application/json" \
            -H "X-API-Key: hackathon-api-key-2026" \
            -d '{
              "type": "incident",
              "incident_id": "00000000-0000-0000-0000-000000000000",
              "message": "CI test notification",
              "recipient": "ci@test.com",
              "severity": "high"
            }')
          echo "Notifications: $RESPONSE"
          echo "‚úÖ Notification service works"

      - name: Test Prometheus metrics
        run: |
          curl -sf http://localhost:9090/-/healthy && echo "‚úÖ Prometheus healthy" || echo "‚ö†Ô∏è Prometheus not reachable"

      - name: Test Grafana
        run: |
          curl -sf http://localhost:3000/api/health && echo "‚úÖ Grafana healthy" || echo "‚ö†Ô∏è Grafana not reachable"

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "üìã Service logs:"
          docker compose logs --tail=50

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # =============================================
  # 6. Deploy (only on main)
  # =============================================
  deploy:
    name: üöÄ Deploy
    runs-on: ubuntu-latest
    needs: integration
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    defaults:
      run:
        working-directory: incident-platform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_USER=hackathon
          POSTGRES_PASSWORD=hackathon2026
          POSTGRES_DB=incident_platform
          API_KEYS=hackathon-api-key-2026
          LOGIN_API_KEY=hackathon-api-key-2026
          AUTH_USERS=admin:admin,operator:operator
          GRAFANA_ADMIN_USER=admin
          GRAFANA_ADMIN_PASSWORD=admin
          EOF

      - name: Deploy with Docker Compose
        run: |
          echo "üöÄ Deploying commit ${{ github.sha }}..."
          docker compose up -d --build
          echo "‚è≥ Waiting for services to start..."
          sleep 30

      - name: Wait for databases healthy
        run: |
          for db in alert-db incident-db notification-db; do
            echo "‚è≥ Waiting for $db..."
            for i in $(seq 1 20); do
              if docker compose exec -T $db pg_isready -U hackathon 2>/dev/null; then
                echo "‚úÖ $db is ready"
                break
              fi
              sleep 5
            done
          done

      - name: Wait for all services healthy
        run: |
          echo "‚è≥ Waiting for services to become healthy..."
          for i in $(seq 1 30); do
            HEALTHY=$(docker compose ps --format json | grep -c '"healthy"' || true)
            echo "  Attempt $i: $HEALTHY services healthy"
            if [ "$HEALTHY" -ge 8 ]; then
              echo "‚úÖ All services healthy!"
              break
            fi
            sleep 10
          done
          docker compose ps

      - name: Health check all services
        run: |
          FAILED=0
          for endpoint in \
            "Alert-Ingestion|http://localhost:8001/health" \
            "Incident-Management|http://localhost:8002/health" \
            "OnCall-Service|http://localhost:8003/health" \
            "Notification-Service|http://localhost:8004/health" \
            "API-Gateway|http://localhost:8080/health" \
            "Prometheus|http://localhost:9090/-/healthy" \
            "Grafana|http://localhost:3000/api/health"; do
            
            NAME=$(echo "$endpoint" | cut -d'|' -f1)
            URL=$(echo "$endpoint" | cut -d'|' -f2)
            
            if curl -sf "$URL" > /dev/null 2>&1; then
              echo "‚úÖ $NAME is healthy"
            else
              echo "‚ùå $NAME failed health check"
              FAILED=$((FAILED + 1))
            fi
          done
          
          if [ "$FAILED" -gt 0 ]; then
            echo "‚ùå $FAILED service(s) failed health checks"
            docker compose logs --tail=20
            exit 1
          fi

      - name: Smoke test - Login
        run: |
          RESPONSE=$(curl -sf -X POST http://localhost:8080/api/v1/auth/login \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"admin"}')
          echo "$RESPONSE" | grep -q "api_key" && echo "‚úÖ Login works" || (echo "‚ùå Login failed" && exit 1)

      - name: Smoke test - Create Alert & Incident
        run: |
          RESPONSE=$(curl -s -X POST http://localhost:8080/api/v1/alerts \
            -H "Content-Type: application/json" \
            -H "X-API-Key: hackathon-api-key-2026" \
            -d '{
              "source": "deploy-smoke-test",
              "severity": "low",
              "message": "Deploy smoke test alert",
              "service": "ci-deploy"
            }')
          echo "Alert response: $RESPONSE"
          echo "$RESPONSE" | grep -q '"incident_id"' && echo "‚úÖ Alert ‚Üí Incident pipeline works" || echo "‚ö†Ô∏è Alert accepted but no incident created"

      - name: Smoke test - Get Incidents
        run: |
          RESPONSE=$(curl -sf http://localhost:8080/api/v1/incidents \
            -H "X-API-Key: hackathon-api-key-2026")
          echo "Incidents: $RESPONSE"
          echo "‚úÖ Incident listing works"

      - name: Smoke test - Notification
        run: |
          RESPONSE=$(curl -s -X POST http://localhost:8080/api/v1/notify \
            -H "Content-Type: application/json" \
            -H "X-API-Key: hackathon-api-key-2026" \
            -d '{
              "incident_id": "00000000-0000-0000-0000-000000000000",
              "channel": "mock",
              "message": "Deploy smoke test notification",
              "recipient": "deploy@test.com"
            }')
          echo "Notification: $RESPONSE"
          echo "‚úÖ Notification service works"

      - name: Deployment summary
        run: |
          echo "========================================="
          echo "üöÄ DEPLOYMENT SUCCESSFUL"
          echo "========================================="
          echo "üìÖ Date: $(date)"
          echo "üîñ Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo ""
          echo "üì¶ Services deployed:"
          docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "üîó Access URLs:"
          echo "  Web UI:      http://localhost:3001"
          echo "  API Gateway: http://localhost:8080"
          echo "  Grafana:     http://localhost:3000"
          echo "  Prometheus:  http://localhost:9090"
          echo "========================================="

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "üìã Service logs:"
          docker compose logs --tail=50

      - name: Cleanup
        if: always()
        run: docker compose down -v